<!DOCTYPE html>
<html lang="en">
  
<head>
<meta charset="UTF-8">
<title>VTT Translator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
:root {
  --bg:#0f0f0f; --fg:#eee; --box:#1a1a1a; --btn:#1abc9c;
}
.light {
  --bg:#f4f4f4; --fg:#111; --box:#fff; --btn:#3498db;
}
body {
  background:var(--bg); color:var(--fg);
  font-family:Arial; padding:20px;
}
input, textarea, button {
  width:100%; margin:6px 0; padding:10px;
  background:var(--box); color:var(--fg);
  border:1px solid #555;
}
button {
  background:var(--btn); border:0; font-size:16px;
  cursor:pointer;
}
textarea { height:200px; }
#preview {
  background:#000; color:#0f0; padding:12px;
  font-family:monospace; min-height:80px;
}
small { opacity:.7 }
</style>
</head>

<body>
<h2>üåç VTT Subtitle Translator</h2>

<button onclick="toggleTheme()">üåì Dark / Light</button>

<input type="file" id="file" accept=".vtt">
<input id="url" placeholder="üì° VTT URL (CORS-safe)">
<input id="target" value="hr" placeholder="Target language (hr,en,de‚Ä¶)">

<button id="go" onclick="processVTT()">üîÅ Translate</button>

<textarea id="output" placeholder="Translated VTT..."></textarea>

<h3>üéß Live subtitle preview</h3>
<div id="preview">Waiting‚Ä¶</div>

<button onclick="download()">üíæ Download VTT</button>
<small id="info"></small>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

function toggleTheme(){
  document.body.classList.toggle("light");
}

async function fetchVTT(){
  const f=file.files[0];
  const u=url.value.trim();
  if(f) return await f.text();
  if(u) return await fetch(u).then(r=>r.text());
  alert("Upload file or enter URL");
}

function normalizeVTT(text){
  const lines=text.split(/\r?\n/);
  let out=["WEBVTT",""];
  for(let l of lines){
    if(l.includes("-->")) out.push(l);
    else if(l.trim() && !l.startsWith("NOTE") && !l.match(/^\d+$/))
      out.push(l.trim());
  }
  return out.join("\n");
}

function timeToMs(t){
  const [h,m,s]=t.replace(",",".").split(":");
  return (+h)*3600000 + (+m)*60000 + (+parseFloat(s))*1000;
}

async function detectLanguage(text){
  const r=await fetch("https://libretranslate.de/detect",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({q:text})
  });
  const j=await r.json();
  return j[0]?.language || "auto";
}

async function translateBatch(txt, target){
  const r=await fetch("https://libretranslate.de/translate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      q:txt,
      source:"auto",
      target:target,
      format:"text"
    })
  });
  const j=await r.json();
  return j.translatedText;
}

async function processVTT(){
  go.disabled=true;
  info.innerText="Loading VTT‚Ä¶";

  let raw=normalizeVTT(await fetchVTT());
  const lines=raw.split(/\r?\n/);

  let blocks=[],i=0;
  while(i<lines.length){
    if(lines[i].includes("-->")){
      const time=lines[i++];
      let txt=[];
      while(i<lines.length && lines[i].trim()){
        txt.push(lines[i++]);
      }
      const [a,b]=time.split(" --> ");
      blocks.push({
        time,
        start:timeToMs(a),
        end:timeToMs(b),
        txt:txt.join(" ")
      });
    }
    i++;
  }

  info.innerText="Detecting language‚Ä¶";
  const src=await detectLanguage(blocks[0].txt);
  info.innerText=`Detected: ${src} ‚Üí ${target.value}`;

  let out=["WEBVTT","Kind: subtitles",`Language: ${target.value}`,""];

  for(let i=0;i<blocks.length;i+=3){
    info.innerText=`Translating ${i}/${blocks.length}`;
    const b=blocks.slice(i,i+3);
    const joined=b.map(x=>x.txt).join("\n###\n");
    const tr=await translateBatch(joined,target.value);
    const p=tr.split("\n###\n");

    b.forEach((x,n)=>{
      x.trans=p[n]||x.txt;
      out.push(x.time);
      out.push(x.trans);
      out.push("");
    });

    await new Promise(r=>setTimeout(r,800));
  }

  output.value=out.join("\n");
  startPreview(blocks);
  go.disabled=false;
  info.innerText="Done ‚úî";
}

function startPreview(blocks){
  let i=0;
  const start=Date.now();
  const timer=setInterval(()=>{
    const t=Date.now()-start;
    if(i>=blocks.length){ clearInterval(timer); return; }
    if(t>=blocks[i].start){
      preview.innerText=blocks[i].trans || blocks[i].txt;
    }
    if(t>=blocks[i].end){
      preview.innerText="";
      i++;
    }
  },50);
}

function download(){
  const blob=new Blob([output.value],{type:"text/vtt"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="translated.vtt";
  a.click();
}
</script>
</body>
</html>